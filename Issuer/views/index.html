<!DOCTYPE html>
<html>
  <head>
    <title>Issuer_part</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="../public/css/style.css" type="text/css" />
    <script src="http://code.jquery.com/jquery-latest.js "></script>
    <script type="text/javascript" src="../lib/web3.js"></script>
    <script type="text/javascript" src="./product.js"></script>
    <script type="text/javascript" src="../lib/bignumber.min.js"></script>
    <script type="text/javascript" src="../public/js/ethereumjs-tx.js"></script>
    <script type="text/javascript" src="../privateKeystore/issuer1/IS1_privatekey.js"></script>


	<script type="text/javascript">
	// $(document).ready(function(){
    //     let DEBUG = 1
            console.log('starting...')
            //connect web3 and check if web3 is connected correctly
            if (typeof web3 !== 'undefined') {
                web3 = new Web3(web3.currentProvider)
            } else {
                // set the provider you want from Web3.providers
                web3 = new Web3(
                    new Web3.providers.HttpProvider("http://localhost:8545")
                )
            }

            if (web3.isConnected()) {
                console.log('connected')
            } else {
                console.log('not connected')
                exit
            }
            
        var contractAddress = "0xcb227bb17c87e03e2136ee8430ec670ac0384220";
        var vc = web3.eth.contract(abi).at(contractAddress);

		let listevent = vc.Instructor();  // // smartContract value = Coursetro.Instructor() , event define
		listevent.watch(function (error, result) {  // HTML event update
			console.log(result);
			if (!error) {
				showList();
			} else {
				console.log(error);
			}
		});  // end of listevent.watch(function(error, result){

		function showList() {
			var table = document.getElementById("table1");
			var length = vc.getNumOfProducts();

			// // 원래 테이블 지우기
			// // $('#table').remove();
			let Parent = document.getElementById("table1");
			while (Parent.hasChildNodes()) {
				Parent.removeChild(Parent.firstChild);
			}

			for (var i = 0; i < length; i++) {
				var candidate = vc.getProductString(i);
				var row = table.insertRow();
				var cell1 = row.insertCell(0);
				var cell2 = row.insertCell(1);
				cell1.innerHTML = candidate;
			}
        }

        function addTransaction() {        
            // 1. nonce 값 조회
            const fromAddress = document.getElementById("fromAddress").value;
            const toAddress = "0xf912eab5d7cfcb3f762ca5f53c057ca360b9dc45"
            web3.eth.getTransactionCount(fromAddress, function(err, nonce) {

                console.log(web3.toWei(0.1, 'ether'))

                // 2. 트랙잭션 데이터 생성
                const EthereumTx = require('ethereumjs-tx').Transaction
                const txParams = {
                    nonce: web3.toHex(nonce),
                    to: toAddress,
                    value: web3.toHex(web3.toWei(0.1, 'ether')), // 0.1 이더
                    gasPrice: web3.toHex(web3.toWei(1, 'Gwei')), // 가스 가격(Gwei 단위)
                    gasLimit: web3.toHex(300000), // 가스 최대 사용량
                    data: '0Xc0de'
                    // EIP 155 chainId - mainnet: 1, ropsten: 3
                    // chainId: 3 //네트워크 ID(3=Ropsten Tesetnet) 
                }
                const tx = new EthereumTx(txParams)

                // 3. 트랜잭션 서명
                let privateKey = new ethereumjs.Buffer.Buffer('713698cbaf055c391e612b736f39bfa8cc6c345a4f196450b15a72b01fa8ada2','hex')
                tx.sign(privateKey)

                // 4. 트랜잭션 전송하기
                const serializedTx = '0x' + tx.serialize().toString('hex')
                web3.eth.sendRawTransaction(serializedTx, function(err, txId) {
                    if (!err) {
                        console.log('txId: ', txId) // 전송된 트랜잭션 Hash값
                    }
                })
            })
        }

		function addProduct() {
			var candidate = document.getElementById("did").value;
			var account = document.getElementById("fromAddress").value;
			if (web3.personal.unlockAccount(account, document.getElementById('pass').value)) {
				vc.addProduct(candidate, { from: account, gas: 2000000 }, function (err, result) {
					if (!err) alert("트랜잭션이 성공적으로 전송되었습니다. \n" + result)
				});
			}
        }        
        
    // })
    </script>
  </head>
  
  <body>
    <h1>did 등록</h1>
    <div>
        계 정:
        <input type="text" size="45" id="fromAddress" value="0xf912eab5d7cfcb3f762ca5f53c057ca360b9dc45">
        <p></p>
        패스워드:
        <input type="password" id="pass" value="123">
    </div>
    <br>
    <div>
        <input type="text" id="did" value="did_name">
        <button onClick="addTransaction()">등록</button>
    </div>
    <table id="table1">
        <script>
            showList();
        </script>
  </body>
</html>
